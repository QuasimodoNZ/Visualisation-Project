import os, sys
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "Visualisation_Project.settings")
import django
django.setup()

from d3js_visualiser import models
from d3js_visualiser.views import get_puma_group

import json

groups = {"42": {"name": "Pennsylvania", "matchings": {"03400": ["03401", "03402"], "04100": ["04101", "04111"], "02800": ["02801", "02802"], "02000": ["02001", "02002"], "00900": ["00901", "00903"], "04200": ["04201", "04204"], "02100": ["02101", "02103"], "00190": ["00100", "00200"], "04300": ["04301", "04303"], "02500": ["02501", "02502"], "03100": ["03101", "03102"], "02200": ["02201", "02202"], "04000": ["04001", "04006"], "03900": ["03901", "03904"], "03200": ["03201", "03203"], "03690": ["03600", "03702"], "03000": ["03001", "03002"], "01790": ["01701", "01807"], "03300": ["03301", "03303"], "03800": ["03801", "03802"], "00800": ["00801", "00802"]}}, "48": {"name": "Texas", "matchings": {"05200": ["05201", "05202"], "06890": ["06800", "06900"], "05600": ["05601", "05611"], "04900": ["04901", "04902"], "04500": ["04501", "04503"], "04800": ["04801", "04802"], "02100": ["02101", "02104"], "03700": ["03701", "03703"], "02500": ["02501", "02511"], "04600": ["04601", "04625"], "02200": ["02201", "02202"], "05390": ["05301", "05402"], "02300": ["02301", "02315"], "04700": ["04701", "04702"], "04390": ["04300", "04400"], "00500": ["00501", "00502"], "03500": ["03501", "03505"], "06390": ["06301", "06500"], "03800": ["03801", "03802"], "06690": ["06600", "06704"]}}, "50": {"name": "Vermont", "matchings": {}}, "49": {"name": "Utah", "matchings": {"00500": ["00501", "00507"], "00600": ["00601", "00603"], "00300": ["00301", "00302"]}}, "53": {"name": "Washington", "matchings": {"02190": ["02101", "02200"], "00900": ["00901", "00902"], "00590": ["00500", "00602"], "01890": ["01801", "02009"], "01390": ["01300", "01404"], "01700": ["01701", "01702"], "01000": ["01001", "01005"], "01200": ["01201", "01202"]}}, "02": {"name": "Alaska", "matchings": {"00100": ["00101", "00102"]}}, "25": {"name": "Massachusetts", "matchings": {"03300": ["03301", "03305"]}}, "26": {"name": "Michigan", "matchings": {"03290": ["03200", "03300"], "02500": ["02501", "02508"], "01890": ["01800", "02000"], "03990": ["03900", "04104"], "01390": ["01300", "01403"], "03690": ["03600", "03807"], "02290": ["02200", "02302"], "02600": ["02601", "02602"]}}, "01": {"name": "Alabama", "matchings": {"00290": ["00200", "00300"], "01990": ["01900", "02000"], "02290": ["02200", "02300"], "00900": ["00901", "00905"]}}, "06": {"name": "California", "matchings": {"01490": ["01401", "01506"], "03700": ["03701", "03702"], "03390": ["03301", "03402"], "02990": ["02900", "03002"], "01600": ["01601", "01602"], "03500": ["03501", "03503"], "06290": ["06200", "06602"], "01100": ["01101", "01103"], "02100": ["02101", "02108"], "07790": ["07700", "08005"], "01300": ["01301", "01303"], "01200": ["01201", "01202"], "02590": ["02500", "02602"], "06890": ["06801", "07607"], "06700": ["06701", "06702"], "02800": ["02801", "02802"], "02200": ["02201", "02207"], "02300": ["02301", "02306"], "01990": ["01901", "02002"], "04590": ["04500", "06126"], "02400": ["02401", "02410"], "03890": ["03800", "03903"], "04090": ["04000", "04407"], "08100": ["08101", "08116"], "02700": ["02701", "02714"]}}, "21": {"name": "Kentucky", "matchings": {"01700": ["01701", "01705"], "01900": ["01901", "01902"]}}, "04": {"name": "Arizona", "matchings": {"00100": ["00101", "00122"], "00200": ["00201", "00207"]}}, "05": {"name": "Arkansas", "matchings": {"00990": ["00900", "01000"]}}, "46": {"name": "South Dakota", "matchings": {"00690": ["00600", "00700"]}}, "47": {"name": "Tennessee", "matchings": {"03190": ["03101", "03202"], "01890": ["01800", "02000"], "01390": ["01301", "01400"], "02200": ["02201", "02205"], "00500": ["00501", "00502"], "00800": ["00801", "00802"]}}, "08": {"name": "Colorado", "matchings": {"00500": ["00501", "00502"], "00190": ["00101", "00200"], "00900": ["00901", "00905"], "00800": ["00801", "00822"]}}, "45": {"name": "South Carolina", "matchings": {"02100": ["02101", "02102"], "01090": ["01001", "01200"], "00300": ["00301", "00302"], "00200": ["00201", "00202"]}}, "28": {"name": "Mississippi", "matchings": {"01490": ["01400", "01500"]}}, "29": {"name": "Missouri", "matchings": {"01600": ["01601", "01602"], "01700": ["01701", "01708"], "02490": ["02400", "02500"], "01800": ["01801", "01803"], "00890": ["00800", "01100"]}}, "40": {"name": "Oklahoma", "matchings": {"01390": ["01301", "01700"]}}, "41": {"name": "Oregon", "matchings": {"00700": ["00701", "00702"], "01300": ["01301", "01313"], "01100": ["01101", "01102"]}}, "51": {"name": "Virginia", "matchings": {"00500": ["00501", "00502"], "02800": ["02801", "02803"], "00300": ["00301", "00305"]}}, "24": {"name": "Maryland", "matchings": {"00600": ["00601", "00602"], "00900": ["00901", "00902"], "01100": ["01101", "01107"], "01000": ["01001", "01007"], "00500": ["00501", "00507"], "01200": ["01201", "01204"], "00800": ["00801", "00806"]}}, "39": {"name": "Ohio", "matchings": {"00600": ["00601", "00612"], "00900": ["00901", "00904"], "04490": ["04401", "04503"], "02200": ["02201", "02203"], "00700": ["00701", "00703"], "04300": ["04301", "04302"], "04600": ["04601", "04602"], "01190": ["01101", "01202"], "00500": ["00501", "00502"], "04090": ["04000", "04103"], "00290": ["00201", "00303"], "03000": ["03001", "03002"], "03100": ["03101", "03109"]}}, "27": {"name": "Minnesota", "matchings": {"01590": ["01501", "01602"], "01200": ["01201", "01203"], "01390": ["01301", "01406"], "01000": ["01001", "01002"]}}, "72": {"code": "72", "name": "Puerto Rico", "matchings": {"00800": ["00801", "00802"], "01000": ["01001", "01004"]}}, "20": {"name": "Kansas", "matchings": {"00600": ["00601", "00604"], "01390": ["01300", "01403"]}}, "11": {"name": "District of Columbia", "matchings": {"00100": ["00101", "00105"]}}, "10": {"name": "Delaware", "matchings": {"00100": ["00101", "00104"]}}, "13": {"name": "Georgia", "matchings": {"01500": ["01501", "01505"], "01100": ["01101", "01107"], "01400": ["01401", "01402"], "01300": ["01301", "01305"], "01200": ["01201", "01206"], "03490": ["03400", "03500"]}}, "12": {"name": "Florida", "matchings": {"02800": ["02801", "02802"], "01500": ["01501", "01502"], "03700": ["03701", "03702"], "01100": ["01101", "01107"], "02700": ["02701", "02708"], "00700": ["00701", "00702"], "02400": ["02401", "02404"], "03600": ["03601", "03613"], "01000": ["01001", "01002"], "01900": ["01901", "01903"], "02200": ["02201", "02207"], "02900": ["02901", "02902"], "02000": ["02001", "02003"], "02500": ["02501", "02503"], "01800": ["01801", "01802"], "04000": ["04001", "04020"], "03500": ["03501", "03509"], "03890": ["03800", "03903"], "00100": ["00101", "00102"], "02100": ["02101", "02104"], "02600": ["02601", "02608"]}}, "15": {"name": "Hawaii", "matchings": {"00300": ["00301", "00307"]}}, "22": {"name": "Louisiana", "matchings": {"01490": ["01401", "01502"], "02000": ["02001", "02002"], "01900": ["01901", "01905"], "01090": ["01000", "01100"], "01800": ["01801", "01804"], "00100": ["00101", "00102"]}}, "17": {"name": "Illinois", "matchings": {"03000": ["03001", "03006"], "01100": ["01101", "01102"], "01200": ["01201", "01202"], "01390": ["01300", "01400"], "03300": ["03301", "03305"], "03200": ["03201", "03206"], "00100": ["00101", "00103"], "01790": ["01700", "01800"], "02890": ["02800", "02900"], "03100": ["03101", "03104"], "03490": ["03401", "03519"]}}, "16": {"name": "Idaho", "matchings": {"00690": ["00600", "00700"]}}, "19": {"name": "Iowa", "matchings": {"01490": ["01400", "01500"]}}, "18": {"name": "Indiana", "matchings": {"02000": ["02001", "02002"], "00590": ["00500", "00600"], "00190": ["00100", "00203"], "01900": ["01901", "01902"], "00990": ["00900", "01000"], "02300": ["02301", "02307"], "03790": ["03700", "03800"]}}, "31": {"name": "Nebraska", "matchings": {"00700": ["00701", "00702"], "00900": ["00901", "00904"], "00800": ["00801", "00802"]}}, "30": {"name": "Montana", "matchings": {}}, "37": {"name": "North Carolina", "matchings": {"00990": ["00901", "01000"], "01690": ["01601", "01700"], "00200": ["00201", "00202"], "01890": ["01800", "01900"], "02690": ["02601", "02802"], "03690": ["03600", "03700"]}}, "36": {"name": "New York", "matchings": {"04100": ["04101", "04114"], "00790": ["00700", "00804"], "00990": ["00901", "01005"], "03700": ["03701", "03710"], "04200": ["04201", "04212"], "02200": ["02201", "02202"], "03900": ["03901", "03903"], "02400": ["02401", "02402"], "04300": ["04301", "04312"], "03300": ["03301", "03303"], "00400": ["00401", "00402"], "03600": ["03601", "03602"], "01500": ["01501", "01502"], "02600": ["02601", "02602"], "03200": ["03201", "03202"], "04000": ["04001", "04018"], "03800": ["03801", "03810"], "03100": ["03101", "03102"], "03490": ["03400", "03506"]}}, "35": {"name": "New Mexico", "matchings": {"00600": ["00601", "00605"]}}, "34": {"name": "New Jersey", "matchings": {"01500": ["01501", "01504"], "00690": ["00601", "00703"], "01100": ["01101", "01105"], "01200": ["01201", "01203"], "02100": ["02101", "02104"], "01390": ["01301", "01404"], "01000": ["01001", "01002"], "01890": ["01800", "01903"], "02200": ["02201", "02202"], "02000": ["02001", "02003"], "00300": ["00301", "00306"], "02300": ["02301", "02302"], "00900": ["00901", "00905"], "00490": ["00400", "00502"], "00100": ["00101", "00102"]}}, "33": {"name": "New Hampshire", "matchings": {}}, "55": {"name": "Wisconsin", "matchings": {"00290": ["00200", "00300"], "01190": ["01100", "01200"], "02090": ["02001", "02300"]}}, "32": {"name": "Nevada", "matchings": {"00500": ["00501", "00511"], "00190": ["00100", "00200"]}}}

puma_to_group = {}
group_to_puma = {} # state__code ->

def create_groups(st, code):
    g = [code]
    if st in groups and code in groups[st]['matchings']:
        grp_range = groups[st]['matchings'][code]
        qs = models.PublicUseMicrodataArea.objects.filter(state__code=st, code__gte=grp_range[0], code__lte=grp_range[1])
        for puma in qs:
            g.append(format(puma.code, '05'))
    if st == '08' and code == '00822':
        print '1: ' + str(g)
    if st == '55' and code == '02090':
        print '2: ' + str(g) + ' - ' + str(grp_range)
    if st == '06' and code == '02700':
        print '3: ' + str(g) + ' - ' + str(grp_range)

    return list(set(g))

for puma in models.PublicUseMicrodataArea.objects.filter(state__code__lte=72):
    st = format(puma.state.code, '02')
    code = format(puma.code, '05')
    group = create_groups(st, code)

    # if not st in puma_to_group:
    #     puma_to_group[st] = {}
    # puma_to_group[st][code] = group
    #
    if not st in group_to_puma:
        group_to_puma[st] = {}
    if not code in group_to_puma[st]:
        group_to_puma[st][code] = group
    else:
        print 'error'
    # group_to_puma[st][group].append(code)

# print 'puma_to_group: '
# print puma_to_group
# print '\n\n\n'
print group_to_puma
# for key, val in puma_to_group.iteritems():
#     print '{}: {}'.format(key, val)
# gtp = open('group_to_puma.json', 'w')
# json.dump(group_to_puma, gtp)
# gtp.close()
# ptg = open('puma_to_group.json', 'w')
# json.dump(puma_to_group, ptg)
# ptg.close()
